# 1.nginx
nginx是一个开源且高性能、可靠的HTTP中间件和代理服务器
# 2.学习环境
## 2.1 操作系统
CENTOS>=7.0,位数x64 CENTOS 7.2
## 2.2 环境确认
### 2.2.1关闭iptables
iptables命令是Linux上常用的防火墙软件
| 功能 | 命令 |
| --- | --- |
| 停止防火墙 | systemctl stop firewalld.service
| 永久关闭防火墙 | systemctl disable firewalld.service |
### 2.2.2 确认停用 selinux
- 安全增强型 Linux (Security-Enhanced Linux)简称SELinux,它是一个Linux内核模块，也是Linux的一个安全子系统。
- SELinux 主要作用就是最大限度地减少系统中服务进程可访问的资源（最小权限原则）。
| 功能 | 命令 |
| --- | --- |
| 检查状态 | getenforce |
| 检查状态 | /usr/sbin/sestatus -v |
| 临时关闭 | setenforce 0 |
| 永久关闭 | /etc/selinux/config SELINUX=enforcing 改为SELINUX=disabled |
### 2.2.3 安装依赖模块
```javascript
yum  -y install gcc gcc-c++ autoconf pcre pcre-devel make automake
yum  -y install wget httpd-tools vim
```
# 3. nginx的优势
- IO多路复用 多个描述符的IO操作都能在一个线程里并发交替顺序完成,复用线程
    - select 线性遍历文件描述符列表 1，效率低下 2.最多只能有1024
    - epoll 每当fd就绪，采用系统回调函数将fd放入 1.效率高 2.没有1024限制
- CPU亲和 一种把CPU核心和Nginx工作进程绑定方式，把每个worker进程固定在一个CPU上执行，减少切换CPU和提交缓存命中率，获得更好的性能。
- sendfile 零拷贝传输模式 
![](/public/images/usercore.jpg)

# 4.nginx安装
## 4.1 版本分类
- Mainline version 开发板
- Stable version 稳定版
- Legacy versions 历史版本
## 4.2 下载地址
- [nginx](http://nginx.org/en/download.html)
- [linux_packages](http://nginx.org/en/linux_packages.html#stable)
## 4.3 CentOS下YUM安装
/etc/yum.repos.d/nginx.repo
```javascript
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
```
```javascript
yum install nginx -y
nginx -v
nginx -V
```
# 5.目录
## 5.1 安装目录
查看配置文件和目录
```javascript
rpm -ql nginx
```
## 5.2 配置文件
| 类型 | 路径 | 用途 |
| --- | --- | --- |
| 配置文件 | /etc/logrotate.d/nginx | 用于logrotate服务的日志切割 |
| 配置文件 | /etc/nginx /etc/nginx/nginx.conf /etc/nginx/conf.d /etc/nginx/conf.d/default.conf | 主配置文件 |
| 配置文件 | /etc/nginx/fastcgi_params /etc/nginx/scgi_params /etc/nginx/uwsgi_params | cgi配置，fastcgi配置 |
| 配置文件 | /etc/nginx/koi-utf /etc/nginx/koi-win /etc/nginx/win-utf | 编码转换映射转化文件 |
| 配置文件 | /etc/nginx/mime.types | 设置http协议的Content-Type与扩展名对应关系 |
| 配置文件 | /usr/lib/systemd/system/nginx-debug.service /usr/lib/systemd/system/nginx.service /etc/sysconfig/nginx /etc/sysconfig/nginx-debug | 用于配置系统守护进程管理器管理方式 |
| 配置文件 | /etc/nginx/modules /usr/lib64/nginx/modules | nginx模块目录 |
| 命令 | /usr/share/doc/nginx-1.14.0 /usr/share/doc/nginx-1.14.0/COPYRIGHT | nginx的手册和帮助文件 |
| 目录 | /var/cache/nginx | nginx的缓存目录 |
| 目录 | /var/log/nginx | nginx的日志目录 |

## 5.3 编译参数
### 5.3.1 安装目录和路径
```bash
--prefix=/etc/nginx
--sbin-path=/usr/sbin/nginx
--modules-path=/usr/lib64/nginx/modules
--conf-path=/etc/nginx/nginx.conf
--error-log-path=/var/log/nginx/error.log
--http-log-path=/var/log/nginx/access.log
--pid-path=/var/run/nginx.pid
--lock-path=/var/run/nginx.lock
```
### 5.3.2 执行对应模块时，nginx所保留的临时性文件
```bash
--http-client-body-temp-path=/var/cache/nginx/client_temp 
--http-proxy-temp-path=/var/cache/nginx/proxy_temp 
--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp 
--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp 
--http-scgi-temp-path=/var/cache/nginx/scgi_temp 
```
### 5.3.3 设置nginx进程启动的用户和用户组
```bash
--user=nginx
--group=nginx
```
### 5.3.4 设置额外的参数将被添加到CFLAGS变量
```bash
--with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong'
```
### 5.3.5 设置附加的参数, 链接系统库
```bash
--with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie'
```
### 5.3.6 其他参数
```bash
--with-compat 
--with-file-aio 
--with-threads 
--with-http_addition_module 
--with-http_auth_request_module 
--with-http_dav_module 
--with-http_flv_module 
--with-http_gunzip_module 
--with-http_gzip_static_module 
--with-http_mp4_module 
--with-http_random_index_module 
--with-http_realip_module 
--with-http_secure_link_module 
--with-http_slice_module 
--with-http_ssl_module 
--with-http_stub_status_module 
--with-http_sub_module 
--with-http_v2_module 
--with-mail 
--with-mail_ssl_module 
--with-stream 
--with-stream_realip_module 
--with-stream_ssl_module 
--with-stream_ssl_preread_module 
--param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' 
```
# 5.配置文件
- /etc/nginx/nginx.conf
- /etc/nginx/conf.d/*.conf /etc/nginx/conf.d/default.conf
## 5.1 全局和服务配置
| 分类 | 配置项 | 作用 |
| --- | --- | --- |
| 全局 | user | 设置nginx服务的系统使用用户 |
| 全局 | worker_processes | 工作进程数，一般和CPU数量相同 |
| 全局 | error_log | nginx的错误日志 |
| 全局 | pid | nginx服务启动时的pid |

/etc/nginx/nginx.conf
```bash
user nginx; 设置nginx服务的系统使用用户
worker_processes 1; 工作进程数，一般和CPU数量相同

error_log /var/log/nginx/error.log warn; nginx的错误日志
pid /var/run/nginx.pid; nginx服务启动时的pid

events {
    worker_connections 1024; 每个进程允许的最大连接数 10000
}

http {
    include /etc/nginx/mime.types; // 文件后缀和类型的对应关系
    default_type application/octet-stream; //默认content-type

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request"'
                        '$status $body_bytes_sent "$http_referer"'
                        '"$http_user_agent" "$http_x_forwarded_for"'; // 日志记录格式
    
    access_log  /var/log/nginx/access.log   main; // 默认访问日志

    sendfile    on; //启用sendfile
    #tcp_nopush on; // 懒发送

    keepalive_timeout 65; // 超时时间是65秒

    #gzip on; gzip压缩

    include /etc/nginx/conf.d/*.conf; // 包含的子配置文件
}

```
default.conf
```bash
server {
    listen  80; // 监听的端口号
    server_name localhost; // 用域名方式访问的地址

    #charset koi8-r // 编码
    #access_log /var/log/nginx/host.access.log  main; // 访问日志文件和名称

    location / {
        root    /usr/share/nginx/html; // 静态文件根目录
        index   index.html  index.htm; // 首页的索引文件
    }

    #error_page 404     /404.html; // 指定错误页面

    # redirect server error pages to the static page /50x.html
    # 把后台错误重定向到静态50x.html页面
    error_page  500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    # 代理PHP脚本到80端口上的apache服务器
    # location ~ \.php$ {
    #   proxy_pass  http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    # 把PHP脚本9000端口上监听的FastCGI服务
    # location ~ \.php$ {
    #   root    html;
    #   fastcgi_pass    127.0.0.1:9000;
    #   fastcgi_index   index.php;
    #   fastcgi_param   SCRIPT_FILENAME /scripts$fastcgi_script_name;
    #   include fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    # 不允许访问.htaccess 文件
    # location ~/\.ht {
    #   deny    all;
    #}
}
```
# 6.启动和重新加载
```bash
systemctl restart nginx.service
systemctl reload nginx.service
nginx -s reload
```
# 7.日志类型
## 7.1 日志类型
- access_log 访问日志
- error.log 错误日志
## 7.2 log_format
| 类型 | 用法 |
| --- | --- |
| 语法 | log_format name [escape=default[json] string] |
| 默认 | log_format combined ... |
| Context | http |
案例
```bash
 log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

 log_format  zfpx  '$arg_name $http_referer sent_http_date"';
 access_log  /var/log/nginx/access.log  main;    

 221.216.143.110 - - [09/Jun/2018:22:41:18 +0800] "GET / HTTP/1.1" 200 612 "-" "Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36" "-"
```

# 7.3 HTTP 请求变量
| 名称 | 含义 | 例子 |
| --- | --- | --- |
| arg_PARAMETER | 请求参数 | $arg_name |
| http_HEADER | 请求头 | $http_referer |
| sent_http_HEADER | 响应头 | sent_http_cookie |

# 7.4 内置变量
[ngx_http_log_module](http://nginx.org/en/docs/http/ngx_http_log_module.html) [log_format](http://nginx.org/en/docs/http/ngx_http_log_module.html#log_format)

| 名称 | 含义 |
| --- | --- |
| $remote_addr | 客户端地址 |
| $remote_user | 客户端用户名称 |
| $time_local | 访问时间和时区 |
| $request | 请求的URI和HTTP协议 |
| $http_host | 请求地址，即浏览器中你输入的地址（IP或域名） |
| $status | HTTP请求状态 |
| $body_bytes_sent | 发送给客户端文件内容大小 |

# 8.nginx实战
## 8.1 静态资源Web服务
